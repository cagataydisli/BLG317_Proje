{% extends "base.html" %}

{% block title %}Matches - BSL Database{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>🏀 Match List</h2>
            <a href="/" class="btn btn-sm btn-outline-secondary">← Home</a>
        </div>
        <div>
            <button id="toggleEditMode" class="btn btn-outline-primary" onclick="toggleEditMode()">
                ✏️ Edit Mode
            </button>
            <button id="addMatchBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#addMatchModal">
                + New Match
            </button>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Analytics Section -->
    {% if analytics %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">📊 City-Based Statistics</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>City</th>
                            <th>Total Matches</th>
                            <th>Avg Total Points</th>
                            <th>Highest Scoring Game</th>
                            <th>Home Wins</th>
                            <th>Home Win %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in analytics %}
                        <tr>
                            <td><strong>{{ stat.city }}</strong></td>
                            <td>{{ stat.total_matches }}</td>
                            <td>{{ stat.avg_total_points }}</td>
                            <td><span class="badge bg-warning text-dark">{{ stat.highest_scoring_game }}</span></td>
                            <td>{{ stat.home_wins }}</td>
                            <td>{{ "%.1f"|format((stat.home_wins / stat.total_matches * 100)) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <small class="text-muted">
                * Cities with at least 5 matches played, sorted by average total points.
            </small>
        </div>
    </div>
    {% endif %}

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Sort By:</label>
                    <select name="sort" class="form-select">
                        <option value="match_date">Date</option>
                        <option value="match_week">Week</option>
                        <option value="match_city">City</option>
                        <option value="league">League</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Order:</label>
                    <select name="order" class="form-select">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Limit:</label>
                    <input type="number" name="limit" value="100" min="1" max="10000" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">Apply</button>
                </div>
            </form>
        </div>
    </div>

    <h5>Total Matches: <span class="badge bg-secondary">{{ matches|length }}</span></h5>

    <!-- Matches Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Match ID</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Home Team</th>
                    <th>Score</th>
                    <th>Away Team</th>
                    <th>League</th>
                    <th>Week</th>
                    <th>City</th>
                    <th>Arena</th>
                    <th class="edit-col d-none">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr id="row-{{ match.match_id }}">
                    <td><small>{{ match.match_id }}</small></td>
                    <td>{{ match.match_date }}</td>
                    <td>{{ match.match_hour }}</td>
                    <td>{{ match.home_team }}</td>
                    <td class="text-center">
                        {% if match.home_score is not none and match.away_score is not none %}
                            <span class="badge {% if match.home_score > match.away_score %}bg-success{% elif match.home_score < match.away_score %}bg-secondary{% else %}bg-warning text-dark{% endif %}">
                                {{ match.home_score }} - {{ match.away_score }}
                            </span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ match.away_team }}</td>
                    <td><small>{{ match.league }}</small></td>
                    <td>{{ match.match_week }}</td>
                    <td>{{ match.match_city }}</td>
                    <td><small>{{ match.match_saloon }}</small></td>
                    <td class="edit-col d-none">
                        <button class="btn btn-sm btn-warning" onclick="editMatch('{{ match.match_id }}', {{ match.home_team_id }}, {{ match.away_team_id }}, '{{ match.match_date }}', '{{ match.match_hour }}', {{ match.home_score or 'null' }}, {{ match.away_score or 'null' }}, '{{ match.match_week }}', '{{ match.league }}', '{{ match.match_city }}', '{{ match.match_saloon }}')">
                            ✏️
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMatch('{{ match.match_id }}')">
                            🗑️
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" class="text-center">No matches found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Match Modal -->
<div class="modal fade" id="addMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Add New Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/matches/add" method="POST">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Match ID (Required):</label>
                            <input type="text" name="match_id" class="form-control" required placeholder="e.g., M12345">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">League:</label>
                            <input type="text" name="league" class="form-control" placeholder="bsl-2024-2025">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Home Team:</label>
                            <select name="home_team_id" class="form-select" required>
                                <option value="">-- Select Team --</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}">{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Away Team:</label>
                            <select name="away_team_id" class="form-select" required>
                                <option value="">-- Select Team --</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}">{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Match Date:</label>
                            <input type="date" name="match_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Match Time:</label>
                            <input type="time" name="match_hour" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Week:</label>
                            <input type="text" name="match_week" class="form-control" placeholder="Week 1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">City:</label>
                            <input type="text" name="match_city" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Arena:</label>
                            <input type="text" name="match_saloon" class="form-control">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Add Match</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Match Modal -->
<div class="modal fade" id="editMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Edit Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/matches/update" method="POST">
                    <input type="hidden" name="match_id" id="edit_match_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Match ID:</label>
                            <input type="text" id="edit_match_id_display" class="form-control" disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">League:</label>
                            <input type="text" name="league" id="edit_league" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Home Team:</label>
                            <select name="home_team_id" id="edit_home_team_id" class="form-select" required>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}">{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Away Team:</label>
                            <select name="away_team_id" id="edit_away_team_id" class="form-select" required>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}">{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Home Score:</label>
                            <input type="number" name="home_score" id="edit_home_score" class="form-control" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Away Score:</label>
                            <input type="number" name="away_score" id="edit_away_score" class="form-control" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Week:</label>
                            <input type="text" name="match_week" id="edit_match_week" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Match Date:</label>
                            <input type="date" name="match_date" id="edit_match_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Match Time:</label>
                            <input type="time" name="match_hour" id="edit_match_hour" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">City:</label>
                            <input type="text" name="match_city" id="edit_match_city" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Arena:</label>
                            <input type="text" name="match_saloon" id="edit_match_saloon" class="form-control">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle Edit Mode
    function toggleEditMode() {
        const editCols = document.querySelectorAll('.edit-col');
        const addBtn = document.getElementById('addMatchBtn');
        const editBtn = document.getElementById('toggleEditMode');

        editCols.forEach(col => col.classList.toggle('d-none'));
        addBtn.classList.toggle('d-none');

        if (addBtn.classList.contains('d-none')) {
            editBtn.innerText = "✏️ Edit Mode";
            editBtn.classList.replace("btn-secondary", "btn-outline-primary");
        } else {
            editBtn.innerText = "❌ Close Mode";
            editBtn.classList.replace("btn-outline-primary", "btn-secondary");
        }
    }

    // Edit Match - Populate Modal
    function editMatch(matchId, homeTeamId, awayTeamId, matchDate, matchHour, homeScore, awayScore, matchWeek, league, matchCity, matchSaloon) {
        document.getElementById('edit_match_id').value = matchId;
        document.getElementById('edit_match_id_display').value = matchId;
        document.getElementById('edit_home_team_id').value = homeTeamId;
        document.getElementById('edit_away_team_id').value = awayTeamId;
        document.getElementById('edit_match_date').value = matchDate;
        document.getElementById('edit_match_hour').value = matchHour;
        document.getElementById('edit_home_score').value = homeScore !== null ? homeScore : '';
        document.getElementById('edit_away_score').value = awayScore !== null ? awayScore : '';
        document.getElementById('edit_match_week').value = matchWeek;
        document.getElementById('edit_league').value = league;
        document.getElementById('edit_match_city').value = matchCity;
        document.getElementById('edit_match_saloon').value = matchSaloon;

        const modal = new bootstrap.Modal(document.getElementById('editMatchModal'));
        modal.show();
    }

    // Delete Match
    function deleteMatch(matchId) {
        if(!confirm("Are you sure you want to delete this match?")) return;

        fetch('/matches/delete/' + matchId, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('row-' + matchId).remove();
                alert("Match successfully deleted.");
            } else {
                alert("Could not delete: " + data.error);
            }
        })
        .catch(err => alert("Error: " + err));
    }
</script>
{% endblock %}
