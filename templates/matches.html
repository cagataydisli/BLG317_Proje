{% extends "base.html" %}

{% block title %}Matches - BSL Database{% endblock %}

{% block content %}
<style>
    .match-row a:hover {
        text-decoration: underline !important;
        opacity: 0.8;
    }
</style>
<div class="container-fluid mt-4">
    <!-- ==================== HEADER SECTION ==================== -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">🏀 BSL Match Center</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active">Matches</li>
                </ol>
            </nav>
        </div>
        <div>
            {% if current_user.is_authenticated %}
                <button id="toggleEditMode" class="btn btn-outline-primary" onclick="toggleEditMode()">
                    ✏️ Edit Mode
                </button>
                <button id="addMatchBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#addMatchModal">
                    + Add Match
                </button>
                <span class="badge bg-secondary ms-2">{{ current_user.username }}</span>
                <a href="/logout" class="btn btn-sm btn-outline-danger ms-1">Logout</a>
            {% else %}
                <a href="/login" class="btn btn-primary">🔒 Login to Edit</a>
            {% endif %}
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ==================== QUICK STATS DASHBOARD ==================== -->
    {% if quick_stats %}
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-lg">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center py-3">
                    <h3 class="mb-0">{{ quick_stats.total_matches }}</h3>
                    <small>Total Matches</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center py-3">
                    <h3 class="mb-0">{{ quick_stats.home_wins }}</h3>
                    <small>🏠 Home Wins ({{ quick_stats.home_win_pct }}%)</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg">
            <div class="card bg-danger text-white h-100">
                <div class="card-body text-center py-3">
                    <h3 class="mb-0">{{ quick_stats.away_wins }}</h3>
                    <small>✈️ Away Wins ({{ quick_stats.away_win_pct }}%)</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-6 col-lg">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center py-3">
                    <h3 class="mb-0">{{ quick_stats.avg_total_score }}</h3>
                    <small>Avg Total Points</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-6 col-lg">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body text-center py-3">
                    <h3 class="mb-0">{{ quick_stats.highest_score }}</h3>
                    <small>Highest Total</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ==================== FILTER SECTION ==================== -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
            <div>
                <strong>🔍 Filters</strong>
                <span class="text-muted ms-2 small">{{ total_count }} results</span>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                    <i class="bi bi-funnel"></i> Toggle
                </button>
            </div>
        </div>
        <div class="collapse show" id="filterPanel">
            <div class="card-body">
                <form method="get" id="filterForm">
                    <!-- ROW 1: Team Filters -->
                    <div class="row g-2 mb-2">
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">🏠 Home Team</label>
                            <select name="home_team" class="form-select form-select-sm">
                                <option value="">Any Home Team</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}" {% if home_team_filter == team.team_id|string %}selected{% endif %}>{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">✈️ Away Team</label>
                            <select name="away_team" class="form-select form-select-sm">
                                <option value="">Any Away Team</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}" {% if away_team_filter == team.team_id|string %}selected{% endif %}>{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">🏀 Team Involved (H or A)</label>
                            <select name="any_team" class="form-select form-select-sm">
                                <option value="">Any Team</option>
                                {% for team in teams %}
                                <option value="{{ team.team_id }}" {% if any_team_filter == team.team_id|string %}selected{% endif %}>{{ team.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">🔍 Search Team Name</label>
                            <input type="text" name="search_team" class="form-control form-control-sm"
                                   placeholder="Type to search..." value="{{ search_team or '' }}">
                        </div>
                    </div>

                    <!-- ROW 2: Location & Status Filters -->
                    <div class="row g-2 mb-2">
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">🏆 League</label>
                            <select name="league" class="form-select form-select-sm">
                                <option value="">All Leagues</option>
                                {% for league in leagues %}
                                <option value="{{ league }}" {% if selected_league == league %}selected{% endif %}>{{ league }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">🌆 City</label>
                            <select name="city" class="form-select form-select-sm">
                                <option value="">All Cities</option>
                                {% for city in cities %}
                                <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">🏟️ Arena/Saloon</label>
                            <select name="saloon" class="form-select form-select-sm">
                                <option value="">All Arenas</option>
                                {% for saloon in all_saloons %}
                                <option value="{{ saloon }}" {% if selected_saloon == saloon %}selected{% endif %}>{{ saloon }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">📊 Match Status</label>
                            <select name="match_status" class="form-select form-select-sm">
                                <option value="">All Matches</option>
                                <option value="played" {% if match_status == 'played' %}selected{% endif %}>✅ Played</option>
                                <option value="unplayed" {% if match_status == 'unplayed' %}selected{% endif %}>⏳ Unplayed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">🎯 Game Type</label>
                            <select name="game_closeness" class="form-select form-select-sm">
                                <option value="">All Games</option>
                                <option value="close" {% if game_closeness == 'close' %}selected{% endif %}>🔥 Close (≤5 pts)</option>
                                <option value="blowout" {% if game_closeness == 'blowout' %}selected{% endif %}>💥 Blowout (≥20 pts)</option>
                            </select>
                        </div>
                    </div>

                    <!-- ROW 3: Date & Score Filters -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">📅 Date Preset</label>
                            <select name="date_preset" class="form-select form-select-sm" id="datePreset">
                                <option value="">Custom Range</option>
                                <option value="today" {% if date_preset == 'today' %}selected{% endif %}>Today</option>
                                <option value="week" {% if date_preset == 'week' %}selected{% endif %}>Last 7 Days</option>
                                <option value="month" {% if date_preset == 'month' %}selected{% endif %}>Last 30 Days</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">From Date</label>
                            <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from or '' }}" id="dateFrom">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">To Date</label>
                            <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to or '' }}" id="dateTo">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">Total Score Min</label>
                            <input type="number" name="total_score_min" class="form-control form-control-sm" placeholder="e.g., 140" min="0" value="{{ total_score_min or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">Total Score Max</label>
                            <input type="number" name="total_score_max" class="form-control form-control-sm" placeholder="e.g., 200" min="0" value="{{ total_score_max or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">Min Point Diff</label>
                            <input type="number" name="min_score_diff" class="form-control form-control-sm" placeholder="e.g., 10" min="0" value="{{ min_score_diff or '' }}">
                        </div>
                    </div>

                    <!-- Result Filter Radio Buttons -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-8">
                            <div class="btn-group btn-group-sm flex-wrap" role="group">
                                <input type="radio" class="btn-check" name="score_filter" id="sf_all" value="" {% if not score_filter %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="sf_all">All Results</label>

                                <input type="radio" class="btn-check" name="score_filter" id="sf_home" value="home_wins" {% if score_filter == 'home_wins' %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="sf_home">🏠 Home Wins</label>

                                <input type="radio" class="btn-check" name="score_filter" id="sf_away" value="away_wins" {% if score_filter == 'away_wins' %}checked{% endif %}>
                                <label class="btn btn-outline-danger" for="sf_away">✈️ Away Wins</label>

                                <input type="radio" class="btn-check" name="score_filter" id="sf_high" value="high_scoring" {% if score_filter == 'high_scoring' %}checked{% endif %}>
                                <label class="btn btn-outline-info" for="sf_high">🔥 High Scoring</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select name="per_page" class="form-select form-select-sm">
                                <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                                <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                                <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">Apply Filters</button>
                        </div>
                    </div>

                    <!-- Week Checkboxes (Collapsed) -->
                    <details class="mb-2">
                        <summary class="text-muted small" style="cursor: pointer;">📆 Filter by Week (click to expand)</summary>
                        <div class="mt-2 p-2 bg-light rounded">
                            <div class="row g-1">
                                {% for week in all_weeks[:24] %}
                                <div class="col-auto">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="weeks" value="{{ week }}" id="week_{{ loop.index }}" {% if week in selected_weeks %}checked{% endif %}>
                                        <label class="form-check-label small" for="week_{{ loop.index }}">{{ week }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </details>

                    <!-- ROW 5: Sorting Options -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-1">📊 Sort By</label>
                            <select name="sort" class="form-select form-select-sm">
                                <option value="match_date" {% if request.args.get('sort', 'match_date') == 'match_date' %}selected{% endif %}>Match Date</option>
                                <option value="match_week" {% if request.args.get('sort') == 'match_week' %}selected{% endif %}>Match Week</option>
                                <option value="league" {% if request.args.get('sort') == 'league' %}selected{% endif %}>League</option>
                                <option value="match_city" {% if request.args.get('sort') == 'match_city' %}selected{% endif %}>City</option>
                                <option value="home_score" {% if request.args.get('sort') == 'home_score' %}selected{% endif %}>Home Score</option>
                                <option value="away_score" {% if request.args.get('sort') == 'away_score' %}selected{% endif %}>Away Score</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">🔽 Order</label>
                            <select name="order" class="form-select form-select-sm">
                                <option value="desc" {% if request.args.get('order', 'desc') == 'desc' %}selected{% endif %}>Descending</option>
                                <option value="asc" {% if request.args.get('order') == 'asc' %}selected{% endif %}>Ascending</option>
                            </select>
                        </div>
                    </div>
                </form>
                
                {% if search_team or selected_league or selected_city or date_from or score_filter or selected_weeks or home_team_filter or away_team_filter or any_team_filter or match_status or selected_saloon or game_closeness or date_preset or total_score_min or total_score_max %}
                <div class="mt-2">
                    <a href="/matches" class="btn btn-sm btn-outline-secondary">✕ Clear All Filters</a>
                    <span class="text-muted small ms-2">
                        Active filters:
                        {% if home_team_filter %}<span class="badge bg-primary">Home Team</span>{% endif %}
                        {% if away_team_filter %}<span class="badge bg-primary">Away Team</span>{% endif %}
                        {% if any_team_filter %}<span class="badge bg-primary">Team Involved</span>{% endif %}
                        {% if match_status %}<span class="badge bg-info">Status: {{ match_status }}</span>{% endif %}
                        {% if game_closeness %}<span class="badge bg-warning text-dark">{{ game_closeness }}</span>{% endif %}
                        {% if selected_saloon %}<span class="badge bg-secondary">Arena</span>{% endif %}
                        {% if date_preset %}<span class="badge bg-success">{{ date_preset }}</span>{% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ==================== MATCHES TABLE ==================== -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Date</th>
                            <th class="text-end" style="width: 25%;">Home</th>
                            <th class="text-center" style="width: 100px;">Score</th>
                            <th style="width: 25%;">Away</th>
                            <th>League</th>
                            <th>Venue</th>
                            <th class="edit-col d-none text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr id="row-{{ match.match_id }}" class="match-row">
                            <td>
                                <div class="fw-semibold">{{ match.match_date }}</div>
                                <small class="text-muted">{{ match.match_hour or '' }}</small>
                            </td>
                            <td class="text-end">
                                <a href="/teams/{{ match.home_team_id }}/players" class="text-decoration-none {% if match.home_score and match.away_score and match.home_score > match.away_score %}fw-bold text-success{% else %}text-dark{% endif %}">
                                    {{ match.home_team }}
                                </a>
                                {% if match.home_score and match.away_score and match.home_score > match.away_score %}
                                    <span class="badge bg-success ms-1">W</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if match.home_score is not none and match.away_score is not none %}
                                    <div class="score-box d-inline-flex align-items-center justify-content-center px-3 py-1 rounded {% if match.home_score > match.away_score %}bg-success-subtle{% elif match.home_score < match.away_score %}bg-danger-subtle{% else %}bg-warning-subtle{% endif %}">
                                        <span class="fw-bold fs-5">{{ match.home_score }}</span>
                                        <span class="text-muted mx-2">-</span>
                                        <span class="fw-bold fs-5">{{ match.away_score }}</span>
                                    </div>
                                {% else %}
                                    <span class="badge bg-secondary">TBD</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.home_score and match.away_score and match.home_score < match.away_score %}
                                    <span class="badge bg-success me-1">W</span>
                                {% endif %}
                                <a href="/teams/{{ match.away_team_id }}/players" class="text-decoration-none {% if match.home_score and match.away_score and match.home_score < match.away_score %}fw-bold text-success{% else %}text-dark{% endif %}">
                                    {{ match.away_team }}
                                </a>
                            </td>
                            <td><span class="badge bg-primary bg-opacity-75">{{ match.league }}</span></td>
                            <td>
                                <small>{{ match.match_city }}</small>
                                {% if match.match_saloon %}<br><small class="text-muted">{{ match.match_saloon }}</small>{% endif %}
                            </td>
                            <td class="edit-col d-none text-center">
                                <button class="btn btn-sm btn-outline-warning" onclick="editMatch('{{ match.match_id }}', {{ match.home_team_id }}, {{ match.away_team_id }}, '{{ match.match_date }}', '{{ match.match_hour }}', {{ match.home_score if match.home_score is not none else 'null' }}, {{ match.away_score if match.away_score is not none else 'null' }}, '{{ match.match_week }}', '{{ match.league }}', '{{ match.match_city }}', '{{ match.match_saloon }}')">✏️</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMatch('{{ match.match_id }}')">🗑️</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="text-muted">
                                    <h5>No matches found</h5>
                                    <p>Try adjusting your filters</p>
                                    <a href="/matches" class="btn btn-outline-primary">Clear Filters</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== PAGINATION ==================== -->
    {% if total_pages > 1 %}
    <nav class="d-flex justify-content-between align-items-center mb-5">
        <div class="text-muted small">
            Showing {{ ((current_page - 1) * per_page) + 1 }}-{{ [current_page * per_page, total_count]|min }} of {{ total_count }}
        </div>
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page - 1 }}{%- for key in request.args.keys() if key != 'page' -%}{%- if request.args.getlist(key)|length > 1 -%}{%- for val in request.args.getlist(key) -%}&{{ key }}={{ val }}{%- endfor -%}{%- else -%}&{{ key }}={{ request.args.get(key) }}{%- endif -%}{%- endfor -%}">‹</a>
            </li>
            {% for p in range([1, current_page - 2]|max, [total_pages, current_page + 2]|min + 1) %}
                <li class="page-item {% if p == current_page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}{%- for key in request.args.keys() if key != 'page' -%}{%- if request.args.getlist(key)|length > 1 -%}{%- for val in request.args.getlist(key) -%}&{{ key }}={{ val }}{%- endfor -%}{%- else -%}&{{ key }}={{ request.args.get(key) }}{%- endif -%}{%- endfor -%}">{{ p }}</a>
                </li>
            {% endfor %}
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page + 1 }}{%- for key in request.args.keys() if key != 'page' -%}{%- if request.args.getlist(key)|length > 1 -%}{%- for val in request.args.getlist(key) -%}&{{ key }}={{ val }}{%- endfor -%}{%- else -%}&{{ key }}={{ request.args.get(key) }}{%- endif -%}{%- endfor -%}">›</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    <!-- ==================== ANALYTICS SECTION ==================== -->
    <div class="row">
        <!-- Team Performance Rankings -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">🏀 Team Performance Rankings <small class="text-muted">({{ analytics_display_season }})</small></h6>
                    {% if analytics and analytics|length > 0 %}
                    <span class="badge bg-secondary">{{ analytics|length }} teams</span>
                    {% endif %}
                </div>
                {% if analytics and analytics|length > 0 %}
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Team</th>
                                    <th class="text-center">W-L</th>
                                    <th>Win%</th>
                                    <th>+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in analytics %}
                                <tr class="{% if loop.index <= 3 %}table-success{% elif loop.index > analytics|length - 3 %}table-danger{% endif %}">
                                    <td>
                                        {% if loop.index == 1 %}🥇
                                        {% elif loop.index == 2 %}🥈
                                        {% elif loop.index == 3 %}🥉
                                        {% else %}<span class="badge bg-secondary">{{ loop.index }}</span>{% endif %}
                                    </td>
                                    <td class="fw-semibold">{{ stat.team_name }}</td>
                                    <td class="text-center">
                                        <span class="text-success">{{ stat.wins }}</span>-<span class="text-danger">{{ stat.losses }}</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 18px; min-width: 50px;">
                                            <div class="progress-bar {% if stat.win_pct >= 60 %}bg-success{% elif stat.win_pct >= 40 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ stat.win_pct }}%">
                                                {{ stat.win_pct }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if stat.point_diff > 0 %}<span class="text-success">+{{ stat.point_diff }}</span>
                                        {% elif stat.point_diff < 0 %}<span class="text-danger">{{ stat.point_diff }}</span>
                                        {% else %}<span class="text-muted">0</span>{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    🟢 Top 3 | 🔴 Bottom 3 | Use season filter to change
                </div>
                {% else %}
                <div class="card-body text-center text-muted py-5">
                    <h5>📊 No Analytics Available</h5>
                    <p class="mb-0">Teams need at least 3 games with scores for statistics.<br>Try selecting a different league or removing filters.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Above-Average Home Performances -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">🏠 Above-Average Home Performances</h6>
                    {% if nested_data and nested_data|length > 0 %}
                    <span class="badge bg-warning text-dark">{{ nested_data|length }} games</span>
                    {% endif %}
                </div>
                {% if nested_data and nested_data|length > 0 %}
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Home</th>
                                    <th class="text-center">Score</th>
                                    <th>Away</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in nested_data %}
                                <tr>
                                    <td class="fw-semibold">{{ row.home_team }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ row.home_score }}</span>
                                        <span class="text-muted">-</span>
                                        <span class="badge bg-secondary">{{ row.away_score }}</span>
                                    </td>
                                    <td>{{ row.away_team }}</td>
                                    <td><small class="text-muted">{{ row.match_date }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Home teams scoring above league average
                    {% if league_avg_home_score %}
                    <span class="badge bg-info text-dark ms-2">League Avg: {{ league_avg_home_score }}</span>
                    {% endif %}
                </div>
                {% else %}
                <div class="card-body text-center text-muted py-5">
                    <h5>🏀 No Data Available</h5>
                    <p class="mb-0">No home team performances above average found.<br>Try selecting a different league.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Second Row of Analytics -->
    <div class="row">
        <!-- Recent Wins -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">🏅 Recent Wins</h6>
                    {% if set_operation_data and set_operation_data|length > 0 %}
                    <span class="badge bg-info">{{ set_operation_data|length }} wins</span>
                    {% endif %}
                </div>
                {% if set_operation_data and set_operation_data|length > 0 %}
                <div class="card-body p-0" style="max-height: 350px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        {% for row in set_operation_data %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                            <div>
                                <span class="fw-semibold">{{ row.team_name }}</span>
                                <small class="text-muted ms-2">vs {{ row.opponent }}</small>
                            </div>
                            <span>
                                <span class="badge {% if row.win_type == 'Home Win' %}bg-success{% else %}bg-primary{% endif %}">
                                    {{ row.team_score }}-{{ row.opponent_score }}
                                </span>
                                {% if row.win_type == 'Home Win' %}
                                    <span class="badge bg-success bg-opacity-25 text-dark">🏠 Home</span>
                                {% else %}
                                    <span class="badge bg-primary bg-opacity-25 text-dark">✈️ Away</span>
                                {% endif %}
                                <small class="text-muted ms-2">{{ row.match_date }}</small>
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Latest victories at home and on the road
                </div>
                {% else %}
                <div class="card-body text-center text-muted py-5">
                    <h5>🏆 No Wins Recorded</h5>
                    <p class="mb-0">No victories found for this league.<br>Check that games have scores entered.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Head to Head -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">🥊 Head-to-Head Rivalries</h6>
                    {% if h2h_data and h2h_data|length > 0 %}
                    <span class="badge bg-danger">{{ h2h_data|length }} matchups</span>
                    {% endif %}
                </div>
                {% if h2h_data and h2h_data|length > 0 %}
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Matchup</th>
                                    <th class="text-center">Games</th>
                                    <th class="text-center">Record</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in h2h_data %}
                                <tr>
                                    <td>
                                        <span class="fw-semibold">{{ row.team1 }}</span>
                                        <span class="text-muted mx-1">vs</span>
                                        <span>{{ row.team2 }}</span>
                                    </td>
                                    <td class="text-center"><span class="badge bg-secondary">{{ row.total_games }}</span></td>
                                    <td class="text-center">
                                        <span class="text-success fw-bold">{{ row.team1_wins }}</span>
                                        <span class="text-muted">-</span>
                                        <span class="text-danger fw-bold">{{ row.team2_wins }}</span>
                                        {% if row.draws > 0 %}<span class="text-warning">-{{ row.draws }}</span>{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Frequent opponents with 2+ meetings
                </div>
                {% else %}
                <div class="card-body text-center text-muted py-5">
                    <h5>🥊 No Rivalries Found</h5>
                    <p class="mb-0">No teams have played each other 2+ times.<br>Data may be limited for this league.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Third Row of Analytics: NEW SECTIONS -->
    <div class="row">
        <!-- Biggest Blowouts -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">💥 Biggest Blowouts</h6>
                    {% if biggest_blowouts and biggest_blowouts|length > 0 %}
                    <span class="badge bg-danger">{{ biggest_blowouts|length }} games</span>
                    {% endif %}
                </div>
                {% if biggest_blowouts and biggest_blowouts|length > 0 %}
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Winner</th>
                                    <th class="text-center">Score</th>
                                    <th>Loser</th>
                                    <th class="text-center">Diff</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in biggest_blowouts %}
                                <tr>
                                    <td class="fw-semibold">
                                        {{ row.winner }}
                                        {% if row.winner_location == 'Home' %}
                                        <span class="badge bg-success bg-opacity-25 text-dark">🏠</span>
                                        {% else %}
                                        <span class="badge bg-primary bg-opacity-25 text-dark">✈️</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ row.winner_score }}</span>
                                        <span class="text-muted">-</span>
                                        <span class="badge bg-secondary">{{ row.loser_score }}</span>
                                    </td>
                                    <td>{{ row.loser }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">+{{ row.point_diff }}</span>
                                    </td>
                                    <td><small class="text-muted">{{ row.match_date }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Games with 20+ point differential
                </div>
                {% else %}
                <div class="card-body text-center text-muted py-5">
                    <h5>💥 No Blowouts Found</h5>
                    <p class="mb-0">No games with 20+ point difference.<br>Competitive league!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Home vs Away Performance -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">🏠🆚✈️ Home vs Away Performance</h6>
                    {% if home_away_stats and home_away_stats|length > 0 %}
                    <span class="badge bg-purple">{{ home_away_stats|length }} teams</span>
                    {% endif %}
                </div>
                {% if home_away_stats and home_away_stats|length > 0 %}
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Team</th>
                                    <th class="text-center">🏠 W-L</th>
                                    <th class="text-center">✈️ W-L</th>
                                    <th class="text-center">Diff</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in home_away_stats %}
                                <tr>
                                    <td class="fw-semibold small">{{ row.team_name }}</td>
                                    <td class="text-center">
                                        <small>
                                            <span class="text-success">{{ row.home_wins }}</span>-<span class="text-danger">{{ row.home_games - row.home_wins }}</span>
                                            <span class="badge bg-success bg-opacity-10 text-dark ms-1">{{ row.home_win_pct }}%</span>
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <small>
                                            <span class="text-success">{{ row.away_wins }}</span>-<span class="text-danger">{{ row.away_games - row.away_wins }}</span>
                                            <span class="badge bg-primary bg-opacity-10 text-dark ms-1">{{ row.away_win_pct }}%</span>
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        {% set diff = row.home_win_pct - row.away_win_pct %}
                                        {% if diff > 10 %}
                                            <span class="badge bg-success">+{{ diff|round(1) }}%</span>
                                        {% elif diff < -10 %}
                                            <span class="badge bg-danger">{{ diff|round(1) }}%</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ diff|round(1) }}%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Win % comparison: Home advantage indicator
                </div>
                {% else %}
                <div class="card-body text-center text-muted py-5">
                    <h5>📊 No Data Available</h5>
                    <p class="mb-0">Teams need at least 5 games for stats.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ==================== ADD MATCH MODAL ==================== -->
<div class="modal fade" id="addMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">➕ Add New Match</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/matches/add" method="POST">
                    <!-- Match ID is now auto-generated -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">League <span class="text-danger">*</span></label>
                            <select name="league" id="add_league" class="form-select" required onchange="updateTeamDropdowns()">
                                <option value="">Select League</option>
                                {% for league in leagues %}<option value="{{ league }}">{{ league }}</option>{% endfor %}
                            </select>
                            <small class="text-muted">Match ID will be auto-generated</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Week <span class="text-danger">*</span></label>
                            <select name="match_week" class="form-select" required>
                                <option value="">Select Week</option>
                                {% for week in all_weeks %}<option value="{{ week }}">{{ week }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">🏠 Home Team <span class="text-danger">*</span></label>
                            <select name="home_team_id" id="add_home_team" class="form-select" required>
                                <option value="">Select League First</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">✈️ Away Team <span class="text-danger">*</span></label>
                            <select name="away_team_id" id="add_away_team" class="form-select" required>
                                <option value="">Select League First</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" name="match_date" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time</label>
                            <input type="time" name="match_hour" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">City <span class="text-danger">*</span></label>
                            <select name="match_city" id="add_city" class="form-select" required>
                                <option value="">Select City</option>
                                {% for city in cities %}<option value="{{ city }}">{{ city }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Arena</label>
                            <select name="match_saloon" id="add_saloon" class="form-select">
                                <option value="">Select Arena (Optional)</option>
                                {% for saloon in all_saloons %}<option value="{{ saloon }}">{{ saloon }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <hr>
                    <p class="text-muted small">💡 <strong>Scores are optional.</strong> Leave empty if match hasn't been played yet.</p>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-success fw-bold">🏠 Home Score</label>
                            <input type="number" name="home_score" class="form-control border-success" min="0" max="300" placeholder="Leave empty if not played">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-danger fw-bold">✈️ Away Score</label>
                            <input type="number" name="away_score" class="form-control border-danger" min="0" max="300" placeholder="Leave empty if not played">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">✅ Add Match</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ==================== EDIT MATCH MODAL ==================== -->
<div class="modal fade" id="editMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">✏️ Edit Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/matches/update" method="POST">
                    <input type="hidden" name="match_id" id="edit_match_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Match ID</label>
                            <input type="text" id="edit_match_id_display" class="form-control bg-light" disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">League</label>
                            <select name="league" id="edit_league" class="form-select">
                                <option value="">Select League</option>
                                {% for league in leagues %}<option value="{{ league }}">{{ league }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">🏠 Home Team</label>
                            <select name="home_team_id" id="edit_home_team_id" class="form-select" required>
                                <option value="">Select Team</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">✈️ Away Team</label>
                            <select name="away_team_id" id="edit_away_team_id" class="form-select" required>
                                <option value="">Select Team</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-success fw-bold">Home Score</label>
                            <input type="number" name="home_score" id="edit_home_score" class="form-control border-success" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-danger fw-bold">Away Score</label>
                            <input type="number" name="away_score" id="edit_away_score" class="form-control border-danger" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Week</label>
                            <select name="match_week" id="edit_match_week" class="form-select">
                                <option value="">Select Week</option>
                                {% for week in all_weeks %}<option value="{{ week }}">{{ week }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date</label>
                            <input type="date" name="match_date" id="edit_match_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Time</label>
                            <input type="time" name="match_hour" id="edit_match_hour" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">City</label>
                            <select name="match_city" id="edit_match_city" class="form-select">
                                <option value="">Select City</option>
                                {% for city in cities %}<option value="{{ city }}">{{ city }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Arena</label>
                            <select name="match_saloon" id="edit_match_saloon" class="form-select">
                                <option value="">Select Arena</option>
                                {% for saloon in all_saloons %}<option value="{{ saloon }}">{{ saloon }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">💾 Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .match-row:hover {
        background-color: #f8f9fa !important;
    }
    .score-box {
        min-width: 90px;
        white-space: nowrap;
    }
    .bg-success-subtle { background-color: #d1e7dd !important; }
    .bg-danger-subtle { background-color: #f8d7da !important; }
    .bg-warning-subtle { background-color: #fff3cd !important; }
</style>

<script>
    function toggleEditMode() {
        const editCols = document.querySelectorAll('.edit-col');
        const addBtn = document.getElementById('addMatchBtn');
        const editBtn = document.getElementById('toggleEditMode');
        editCols.forEach(col => col.classList.toggle('d-none'));
        addBtn.classList.toggle('d-none');
        if (addBtn.classList.contains('d-none')) {
            editBtn.innerHTML = "✏️ Edit Mode";
            editBtn.className = "btn btn-outline-primary";
        } else {
            editBtn.innerHTML = "✕ Exit Edit";
            editBtn.className = "btn btn-secondary";
        }
    }

    // Store all teams data for filtering
    const allTeams = [
        {% for team in teams %}
        { id: {{ team.team_id }}, name: "{{ team.team_name }}", league: "{{ team.league }}" },
        {% endfor %}
    ];

    // Store all saloons with cities for filtering
    const allCitySaloons = [
        {% for s in saloons_with_cities %}
        { city: "{{ s.city }}", saloon: "{{ s.saloon }}" },
        {% endfor %}
    ];

    // Filter teams by league and populate dropdown
    function filterTeamsByLeague(selectId, selectedLeague, selectedTeamId) {
        const select = document.getElementById(selectId);
        const currentValue = selectedTeamId || select.value;
        
        // Clear existing options
        select.innerHTML = '<option value="">Select Team</option>';
        
        // Filter teams by league
        const filteredTeams = selectedLeague 
            ? allTeams.filter(t => t.league === selectedLeague)
            : allTeams;
        
        // Add filtered options
        filteredTeams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            if (team.id == currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    // Filter saloons by city and populate dropdown
    function filterSaloonsByCity(selectId, selectedCity, selectedSaloon) {
        const select = document.getElementById(selectId);
        const currentValue = selectedSaloon || select.value;
        
        // Clear existing options
        select.innerHTML = '<option value="">Select Saloon (optional)</option>';
        
        // Filter saloons by city
        const filteredSaloons = selectedCity 
            ? allCitySaloons.filter(s => s.city === selectedCity)
            : allCitySaloons;
        
        // Get unique saloons
        const uniqueSaloons = [...new Set(filteredSaloons.map(s => s.saloon))];
        
        // Add filtered options
        uniqueSaloons.forEach(saloon => {
            const option = document.createElement('option');
            option.value = saloon;
            option.textContent = saloon;
            if (saloon === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    // Update team dropdowns when league changes in Edit modal
    document.getElementById('edit_league').addEventListener('change', function() {
        const league = this.value;
        filterTeamsByLeague('edit_home_team_id', league);
        filterTeamsByLeague('edit_away_team_id', league);
    });

    // Update saloon dropdown when city changes in Edit modal
    document.getElementById('edit_match_city').addEventListener('change', function() {
        const city = this.value;
        filterSaloonsByCity('edit_match_saloon', city);
    });

    // Update team dropdowns when league changes in Add modal
    document.getElementById('add_league').addEventListener('change', function() {
        const league = this.value;
        filterTeamsByLeague('add_home_team', league);
        filterTeamsByLeague('add_away_team', league);
    });

    // Update saloon dropdown when city changes in Add modal
    document.getElementById('add_city').addEventListener('change', function() {
        const city = this.value;
        filterSaloonsByCity('add_saloon', city);
    });

    function editMatch(matchId, homeTeamId, awayTeamId, matchDate, matchHour, homeScore, awayScore, matchWeek, league, matchCity, matchSaloon) {
        document.getElementById('edit_match_id').value = matchId;
        document.getElementById('edit_match_id_display').value = matchId;
        document.getElementById('edit_league').value = league;
        
        // Filter teams by league first, then set selected values
        filterTeamsByLeague('edit_home_team_id', league, homeTeamId);
        filterTeamsByLeague('edit_away_team_id', league, awayTeamId);
        
        document.getElementById('edit_match_date').value = matchDate;
        document.getElementById('edit_match_hour').value = matchHour;
        // FIXED: Handle both null and string "null"
        document.getElementById('edit_home_score').value = (homeScore !== null && homeScore !== 'null' && homeScore !== undefined) ? homeScore : '';
        document.getElementById('edit_away_score').value = (awayScore !== null && awayScore !== 'null' && awayScore !== undefined) ? awayScore : '';
        document.getElementById('edit_match_week').value = matchWeek;
        document.getElementById('edit_match_city').value = matchCity;
        
        // Filter saloons by city first, then set selected value
        filterSaloonsByCity('edit_match_saloon', matchCity, matchSaloon);
        
        new bootstrap.Modal(document.getElementById('editMatchModal')).show();
    }

    function deleteMatch(matchId) {
        if(!confirm("Delete match " + matchId + "?")) return;
        fetch('/matches/delete/' + matchId, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('row-' + matchId).remove();
            } else {
                alert("Error: " + data.error);
            }
        });
    }

    // ADDED: Loading state for filter form
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Loading...';
    });

    // NEW: Date preset toggle - disable manual date inputs when preset is selected
    document.getElementById('datePreset').addEventListener('change', function() {
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        if (this.value !== '') {
            dateFrom.disabled = true;
            dateTo.disabled = true;
            dateFrom.value = '';
            dateTo.value = '';
            dateFrom.classList.add('bg-light');
            dateTo.classList.add('bg-light');
        } else {
            dateFrom.disabled = false;
            dateTo.disabled = false;
            dateFrom.classList.remove('bg-light');
            dateTo.classList.remove('bg-light');
        }
    });

    // Initialize on page load
    if (document.getElementById('datePreset').value !== '') {
        document.getElementById('dateFrom').disabled = true;
        document.getElementById('dateTo').disabled = true;
        document.getElementById('dateFrom').classList.add('bg-light');
        document.getElementById('dateTo').classList.add('bg-light');
    }
</script>
{% endblock %}
