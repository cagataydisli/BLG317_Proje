{% extends "base.html" %}

{% block title %}TakÄ±m Listesi{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Ãœst BaÅŸlÄ±k ve Aksiyonlar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>TakÄ±m Listesi</h2>
            <a href="/" class="btn btn-sm btn-outline-secondary">â† Ana Sayfa</a>
        </div>

        <div class="d-flex gap-2">
            {% if current_user.is_authenticated %}
                <button id="toggleEditMode" class="btn btn-outline-primary" onclick="toggleEditMode()">
                    âœï¸ DÃ¼zenle
                </button>

                <button id="addTeamBtn" class="btn btn-success d-none" 
                        data-bs-toggle="modal" data-bs-target="#addTeamModal">
                    + Yeni TakÄ±m
                </button>

                <a href="/logout" class="btn btn-danger">
                    Ã‡Ä±kÄ±ÅŸ Yap ({{ current_user.username }})
                </a>
            {% else %}
                <a href="/login" class="btn btn-primary">
                    ğŸ”’ DÃ¼zenlemek iÃ§in GiriÅŸ Yap
                </a>
            {% endif %}
        </div>
    </div>

    <!-- SEZON FÄ°LTRESÄ° (YENÄ° EKLENDÄ°) -->
    <div class="card mb-4 bg-light border-0">
        <div class="card-body py-2">
            <form action="/teams/table" method="GET" class="d-flex align-items-center gap-3">
                <label class="fw-bold text-secondary mb-0">Sezon SeÃ§iniz:</label>
                <select name="season" class="form-select w-auto" onchange="this.form.submit()">
                    <option value="all" {% if current_season == 'all' or not current_season %}selected{% endif %}>
                        TÃ¼m Sezonlar
                    </option>
                    {% for season in seasons %}
                        <option value="{{ season }}" {% if current_season == season %}selected{% endif %}>
                            {{ season }}
                        </option>
                    {% endfor %}
                </select>
                {% if current_season and current_season != 'all' %}
                    <small class="text-muted">
                        Åu an <strong>{{ current_season }}</strong> sezonu gÃ¶steriliyor.
                        <a href="/teams/table">Filtreyi Temizle</a>
                    </small>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- TakÄ±m Tablosu -->
    <div class="table-responsive shadow-sm">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Staff ID</th>
                    <th>Lig</th>
                    <th>TakÄ±m AdÄ±</th>
                    <th>Åehir</th>
                    <th>KuruluÅŸ</th>
                    <th>Salon & Kapasite</th>
                    {% if current_user.is_authenticated %}
                    <th class="delete-col d-none" style="width: 100px;">Ä°ÅŸlem</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for team in teams %}
                <tr id="row-{{ team.team_id }}">
                    <td><strong>{{ team.team_id }}</strong></td>
                    
                    <td>
                        {% if team.staff_id %}
                            <span class="badge bg-secondary">{{ team.staff_id }}</span>
                        {% else %}
                            <span class="text-muted small">-</span>
                        {% endif %}
                    </td>
                    
                    <td><span class="badge bg-info text-dark">{{ team.league or '-' }}</span></td>
                    
                    <td>
                        <!-- Ä°sim -> Oyuncu SayfasÄ±na -->
                        <a href="/teams/{{ team.team_id }}/players" class="fw-bold text-decoration-none text-dark">
                            {{ team.team_name }}
                        </a>
                        <!-- Ä°kon -> Resmi Siteye -->
                        {% if team.team_url %}
                            <a href="{{ team.team_url }}" target="_blank" class="text-primary ms-1" title="Resmi Site">ğŸ”—</a>
                        {% endif %}
                    </td>
                    
                    <td>{{ team.team_city or '-' }}</td>
                    <td>{{ team.team_year or '-' }}</td>
                    
                    <td>
                        <div class="fw-bold">{{ team.saloon_name or '-' }}</div>
                        <small class="text-muted">
                            {% if team.saloon_capacity %}
                                ğŸ‘¥ {{ "{:,}".format(team.saloon_capacity) }}
                            {% else %}
                                Kapasite Belirsiz
                            {% endif %}
                        </small>
                    </td>

                    {% if current_user.is_authenticated %}
                    <td class="delete-col d-none">
                        <button class="btn btn-sm btn-danger" onclick="deleteTeam({{ team.team_id }})">
                            ğŸ—‘ï¸ Sil
                        </button>
                        <button class="btn btn-sm btn-warning me-1"
                            data-bs-toggle="modal"
                            data-bs-target="#editTeamModal"
                            onclick="fillEditTeam(
                                '{{ team.team_id }}',
                                '{{ team.team_name }}',
                                '{{ team.league }}',
                                '{{ team.team_city }}',
                                '{{ team.team_year }}',
                                '{{ team.team_url }}',
                                '{{ team.staff_id }}',
                                '{{ team.saloon_name }}',
                                '{{ team.saloon_capacity }}',
                                '{{ team.saloon_address }}'
                            )">
                            âœï¸
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <h5 class="text-muted">Bu sezona ait takÄ±m bulunamadÄ±.</h5>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Yeni TakÄ±m Ekleme ModalÄ± -->
<div class="modal fade" id="addTeamModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Yeni TakÄ±m Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/teams/add" method="POST">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">TakÄ±m ID (Zorunlu):</label>
                    <input type="number" name="team_id" class="form-control" placeholder="Ã–rn: 2025" required>
                </div>
                <div class="col-md-8">
                    <label class="form-label fw-bold">TakÄ±m AdÄ± (Zorunlu):</label>
                    <input type="text" name="team_name" class="form-control" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Lig:</label>
                    <input type="text" name="league" class="form-control" placeholder="bsl-2024-2025">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Åehir:</label>
                    <input type="text" name="team_city" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">KuruluÅŸ YÄ±lÄ±:</label>
                    <input type="number" name="team_year" class="form-control" placeholder="1900">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label">Logo/Web URL:</label>
                    <input type="text" name="team_url" class="form-control" placeholder="https://...">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Teknik Kadro ID:</label>
                    <input type="number" name="staff_id" class="form-control">
                </div>
            </div>
            <hr>
            <h6 class="text-success">Salon Bilgileri</h6>
            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label">Salon AdÄ±:</label>
                    <input type="text" name="saloon_name" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Kapasite:</label>
                    <input type="number" name="saloon_capacity" class="form-control" placeholder="SayÄ± giriniz">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Salon Adresi:</label>
                <textarea name="saloon_address" class="form-control" rows="2"></textarea>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-success">âœ… TakÄ±mÄ± Kaydet</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editTeamModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="/teams/update">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">TakÄ±m DÃ¼zenle</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="team_id" id="edit_team_id">

          <div class="mb-2">
            <label>TakÄ±m AdÄ±</label>
            <input class="form-control" name="team_name" id="edit_team_name" required>
          </div>

          <div class="row">
            <div class="col">
              <label>Lig</label>
              <input class="form-control" name="league" id="edit_league">
            </div>
            <div class="col">
              <label>Åehir</label>
              <input class="form-control" name="team_city" id="edit_city">
            </div>
            <div class="col">
              <label>KuruluÅŸ YÄ±lÄ±</label>
              <input class="form-control" name="team_year" id="edit_year">
            </div>
          </div>

          <div class="row mt-2">
            <div class="col">
              <label>Salon AdÄ±</label>
              <input class="form-control" name="saloon_name" id="edit_saloon">
            </div>
            <div class="col">
              <label>Kapasite</label>
              <input class="form-control" name="saloon_capacity" id="edit_capacity">
            </div>
          </div>

          <div class="mt-2">
            <label>Salon Adresi</label>
            <textarea class="form-control" name="saloon_address" id="edit_address" rows="2"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-warning w-100">GÃ¼ncelle</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    function toggleEditMode() {
        const deleteCols = document.querySelectorAll('.delete-col');
        const addBtn = document.getElementById('addTeamBtn');
        const editBtn = document.getElementById('toggleEditMode');
        deleteCols.forEach(col => col.classList.toggle('d-none'));
        addBtn.classList.toggle('d-none');
        if (addBtn.classList.contains('d-none')) {
            editBtn.innerHTML = "âœï¸ DÃ¼zenle";
            editBtn.classList.replace("btn-secondary", "btn-outline-primary");
        } else {
            editBtn.innerHTML = "âŒ Modu Kapat";
            editBtn.classList.replace("btn-outline-primary", "btn-secondary");
        }
    }
    function deleteTeam(id) {
        if(!confirm("Bu takÄ±mÄ± silmek istediÄŸine emin misin?")) return;
        fetch('/teams/delete/' + id, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById('row-' + id);
                row.style.backgroundColor = "#ffcccc";
                setTimeout(() => row.remove(), 500);
            } else {
                alert("Hata: " + (data.error || "Bilinmeyen hata"));
            }
        })
        .catch(err => alert("BaÄŸlantÄ± HatasÄ±: " + err));
    }
</script>
<script>
    function fillEditTeam(id, name, league, city, year, url, staff, saloon, cap, addr) {
        document.getElementById("edit_team_id").value = id;
        document.getElementById("edit_team_name").value = name;
        document.getElementById("edit_league").value = league;
        document.getElementById("edit_city").value = city;
        document.getElementById("edit_year").value = year;
        document.getElementById("edit_saloon").value = saloon;
        document.getElementById("edit_capacity").value = cap;
        document.getElementById("edit_address").value = addr;
    }
</script>

{% endblock %}