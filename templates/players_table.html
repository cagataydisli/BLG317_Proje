{% extends "base.html" %}

{% block title %}Oyuncu Listesi{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>Oyuncu Listesi</h2>
            <a href="/" class="btn btn-sm btn-outline-secondary">â† Ana Sayfaya DÃ¶n</a>
        </div>

        <div>
            <button id="toggleEditMode" class="btn btn-outline-primary" onclick="toggleEditMode()">
                âœï¸ DÃ¼zenle
            </button>

            <button id="addPlayerBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                + Yeni Oyuncu
            </button>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <form action="/players" method="GET" id="filterForm">

                <input type="hidden" name="page" id="pageInput" value="{{ current_page }}">

                <div class="row g-3 align-items-center">

                    <div class="col-md-4">
                        <input type="text" name="search" class="form-control" placeholder="Oyuncu AdÄ± Ara..." value="{{ request.args.get('search', '') }}">
                    </div>

                    <div class="col-md-3">
                        <select name="sort_by" class="form-select" onchange="resetPageAndSubmit()">
                            <option value="">SÄ±ralama SeÃ§iniz...</option>
                            <option value="name_asc" {% if request.args.get('sort_by') == 'name_asc' %}selected{% endif %}>Ä°sim (A-Z)</option>
                            <option value="age_asc" {% if request.args.get('sort_by') == 'age_asc' %}selected{% endif %}>YaÅŸ (GenÃ§ten YaÅŸlÄ±ya)</option>
                            <option value="age_desc" {% if request.args.get('sort_by') == 'age_desc' %}selected{% endif %}>YaÅŸ (YaÅŸlÄ±dan Gence)</option>
                            <option value="height_desc" {% if request.args.get('sort_by') == 'height_desc' %}selected{% endif %}>Boy (Uzundan KÄ±saya)</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <select name="per_page" class="form-select" onchange="resetPageAndSubmit()">
                            <option value="20" {% if per_page == 20 %}selected{% endif %}>20 SatÄ±r</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50 SatÄ±r</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100 SatÄ±r</option>
                            <option value="1000" {% if per_page == 1000 %}selected{% endif %}>TÃ¼mÃ¼</option>
                        </select>
                    </div>

                    <div class="col-md-3 d-flex gap-2">
                        <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#filterModal">
                             Filtrele {% if selected_teams or selected_leagues %}(SeÃ§ili){% endif %}
                        </button>
                        <button type="submit" class="btn btn-primary" onclick="resetPageAndSubmit()">Ara</button>
                    </div>
                </div>

                <div class="modal fade" id="filterModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header"><h5 class="modal-title">DetaylÄ± Filtreleme</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 border-end"><h6>TakÄ±mlar</h6><div style="max-height: 300px; overflow-y: auto;">
                                            {% for team in all_teams %}
                                            <div class="form-check"><input class="form-check-input" type="checkbox" name="teams" value="{{ team }}" id="t_{{ loop.index }}" {% if team in selected_teams %}checked{% endif %}><label class="form-check-label" for="t_{{ loop.index }}">{{ team }}</label></div>
                                            {% endfor %}
                                    </div></div>
                                    <div class="col-md-6"><h6>Ligler</h6><div style="max-height: 300px; overflow-y: auto;">
                                            {% for league in all_leagues %}
                                            <div class="form-check"><input class="form-check-input" type="checkbox" name="leagues" value="{{ league }}" id="l_{{ loop.index }}" {% if league in selected_leagues %}checked{% endif %}><label class="form-check-label" for="l_{{ loop.index }}">{{ league }}</label></div>
                                            {% endfor %}
                                    </div></div>
                                </div>
                            </div>
                            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button><button type="submit" class="btn btn-primary" onclick="resetPageAndSubmit()">Uygula</button></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Oyuncu AdÄ±</th>
                <th>TakÄ±m</th>
                <th>Boy</th>
                <th>YaÅŸ</th> <th>DoÄŸum Tarihi</th>
                <th>Lig</th>
                <th class="delete-col d-none">Ä°ÅŸlem</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr id="row-{{ player.player_id }}">
                <td>{{ player.player_id }}</td>
                <td>{{ player.player_name }}</td>
                <td>
                    {% if player.team_url %}
                        <a href="{{ player.team_url }}" target="_blank">{{ player.team_name or 'TakÄ±msÄ±z' }}</a>
                    {% else %}
                        {{ player.team_name or 'TakÄ±msÄ±z' }}
                    {% endif %}
                </td>
                <td>{{ player.player_height or '-' }}</td>

                <td>
                    {% if player.age != '-' and player.age != 'Bilinmiyor' %}
                        <span class="badge bg-info text-dark">{{ player.age }}</span>
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td>{{ player.player_birthdate or '-' }}</td>
                <td>{{ player.league or '-' }}</td>

                <td class="delete-col d-none">
                    <button class="btn btn-sm btn-danger" onclick="deletePlayer({{ player.player_id }})">
                        ğŸ—‘ï¸ Sil
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">KayÄ±tlÄ± oyuncu bulunamadÄ±.</td> </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if total_pages > 1 %}
    <nav aria-label="Sayfalama" class="mt-3">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <button class="page-link" onclick="goToPage({{ current_page - 1 }})">Â« Ã–nceki</button>
            </li>

            {% for p in range(1, total_pages + 1) %}
                {% if p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
                    <li class="page-item {% if p == current_page %}active{% endif %}">
                        <button class="page-link" onclick="goToPage({{ p }})">{{ p }}</button>
                    </li>
                {% elif p == current_page - 3 or p == current_page + 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <button class="page-link" onclick="goToPage({{ current_page + 1 }})">Sonraki Â»</button>
            </li>
        </ul>
        <div class="text-center text-muted small">
            Toplam {{ total_count }} kayÄ±t, {{ total_pages }} sayfa
        </div>
    </nav>
    {% endif %}
</div>

<div class="modal fade" id="addPlayerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yeni Oyuncu Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/players/add" method="POST">
            <div class="mb-2">
                <label>Oyuncu ID (Benzersiz):</label>
                <input type="number" name="player_id" class="form-control" required>
            </div>
            <div class="mb-2">
                <label>Ad Soyad:</label>
                <input type="text" name="player_name" class="form-control" required>
            </div>
            <div class="mb-2">
                <label>TakÄ±m ID (Opsiyonel):</label>
                <input type="number" name="team_id" class="form-control" placeholder="Ã–rn: 101">
            </div>
            <div class="mb-2">
                <label>Boy:</label>
                <input type="text" name="player_height" class="form-control">
            </div>
            <div class="mb-2">
                <label>DoÄŸum YÄ±lÄ±:</label>
                <input type="text" name="player_birthdate" class="form-control">
            </div>
            <div class="mb-2">
                <label>Lig:</label>
                <input type="text" name="league" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3">Kaydet</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    // DÃ¼zenleme Modunu AÃ§/Kapat
    function toggleEditMode() {
        const deleteCols = document.querySelectorAll('.delete-col');
        const addBtn = document.getElementById('addPlayerBtn');
        const editBtn = document.getElementById('toggleEditMode');

        // Gizli olanlarÄ± gÃ¶ster, gÃ¶sterilenleri gizle (toggle)
        deleteCols.forEach(col => col.classList.toggle('d-none'));
        addBtn.classList.toggle('d-none');

        // Buton metnini deÄŸiÅŸtir
        if (addBtn.classList.contains('d-none')) {
            editBtn.innerText = "âœï¸ DÃ¼zenle";
            editBtn.classList.replace("btn-secondary", "btn-outline-primary");
        } else {
            editBtn.innerText = "âŒ Modu Kapat";
            editBtn.classList.replace("btn-outline-primary", "btn-secondary");
        }
    }

    // Oyuncu Silme Fonksiyonu (AJAX ile sayfayÄ± yenilemeden siler)
    function deletePlayer(id) {
        if(!confirm("Bu oyuncuyu silmek istediÄŸine emin misin?")) return;

        fetch('/players/delete/' + id, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // BaÅŸarÄ±lÄ±ysa satÄ±rÄ± tablodan kaldÄ±r
                document.getElementById('row-' + id).remove();
            } else {
                alert("Silinemedi: " + data.error);
            }
        })
        .catch(err => alert("Hata: " + err));
    }
</script>

<button onclick="topFunction()" id="myBtn" title="YukarÄ± Git">â¬†ï¸</button>

<style>
    /* YukarÄ± Ã‡Ä±k Butonu CSS */
    #myBtn {
        display: none; /* VarsayÄ±lan gizli */
        position: fixed;
        bottom: 20px;
        right: 30px;
        z-index: 99;
        font-size: 18px;
        border: none;
        outline: none;
        background-color: #0d6efd; /* Bootstrap Primary Rengi */
        color: white;
        cursor: pointer;
        padding: 15px;
        border-radius: 50%; /* Yuvarlak */
        box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
    }
    #myBtn:hover {
        background-color: #0b5ed7;
    }
</style>

<script>
    // --- Sayfalama Fonksiyonu ---
    function goToPage(pageNum) {
        // Formdaki gizli page input'unu gÃ¼ncelle ve formu gÃ¶nder
        document.getElementById('pageInput').value = pageNum;
        document.getElementById('filterForm').submit();
    }

    // Arama/SÄ±ralama deÄŸiÅŸince 1. sayfaya dÃ¶nmesi iÃ§in
    function resetPageAndSubmit() {
        document.getElementById('pageInput').value = 1;
        // Form submit iÅŸlemi select/button Ã¼zerinden yapÄ±lÄ±yor
    }

    // --- YukarÄ± Ã‡Ä±k Butonu Fonksiyonu ---
    let mybutton = document.getElementById("myBtn");

    // Sayfa aÅŸaÄŸÄ± kaydÄ±rÄ±lÄ±nca butonu gÃ¶ster
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
            mybutton.style.display = "block";
        } else {
            mybutton.style.display = "none";
        }
    }

    // TÄ±klayÄ±nca yukarÄ± at
    function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }
</script>

{% endblock %}